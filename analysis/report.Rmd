---
title: Age of Empires 2 Civilisation 1v1 Performance Statistics
date: "`r format(Sys.time(), '%d %b %Y')`"
output:
    html_document:
        theme: cerulean
        toc: true
        toc_depth: 3
        css: [www/jquery-ui.css, www/jquery-ui.structure.css, www/styles.css, www/jquery-ui.theme.css]
        includes:
            in_header: www/header.html
---

```{r, echo=FALSE, results=FALSE, message=FALSE}
pkgload::load_all()
library(dbplyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(kableExtra)

meta_solo <- readRDS("./data/ia_meta.Rds")
meta_team <- readRDS("./data/ta_meta.Rds")


```

## Introduction

This document attempts to outline civilisation 1v1 performance metrics in order to
try and identify areas of imbalance within the game. In particular, unless otherwise stated, the 
analysis is based on 1v1 data from ranked matches played on Arabia where both players have an 
ELO > 1200 and are playing different civs (i.e. no mirror matches are included). 

In total `r prettyNum(meta_solo$n_db,big.mark=",",scientific=FALSE)` matches with a known result were recorded between
`r as.Date(meta_solo$db_min)` and `r as.Date(meta_solo$db_max)`. Of these `r prettyNum(meta_solo$n_valid_solo,big.mark=",",scientific=FALSE)`
solo games and `r prettyNum(meta_team$n_valid_team,big.mark=",",scientific=FALSE)` team games met the above mentioned criteria and were included into the analysis.  All data is sourced from https://aoe2.net/.





## Descriptives

### Number of Matches per Patch (Solo Games)
<img src="../outputs/g_ia_desc_VERDIST.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Summary of ELO Distribution (Solo Games)
<img src="../outputs/g_ia_desc_ELODIST.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Play Rate by Civilisation (Solo Games)
<img src="../outputs/g_ia_desc_PR.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Number of Matches per Patch (Team Games)
<img src="../outputs/g_ta_desc_VERDIST.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Summary of ELO Distribution (Team Games)
<img src="../outputs/g_ta_desc_ELODIST.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Play Rate by Civilisation (Team Games)
<img src="../outputs/g_ta_desc_PR.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Play Rate by Civilisation (Solo vs Team Games)
<img src="../outputs/g_pr.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>



## Bradley-Terry Modeling

To assess civilisation performance a Bradley-Terry model was fitted to the data. This model works by assuming that each civilisation has a latent (i.e. hidden/unknown) performance rating value $X_i$. The probability of civilisation $i$ beating civilisation $j$ in match $k$ is then calculated as:
$$\frac{1}{1+e^{-\lambda_{ijk}}}$$

Where:

- $\lambda_{ijk} = X_i - X_j + D_k$  
- $D_k$ is the difference in ELO rating between the two players in match $k$ divided by 25

Fitting this model to the available data results in the following performance score estimates:


Each point represents the estimated performance score for the corresponding civilisation whilst the interval around the point represents the 95% confidence interval, which can be naively thought of to mean that there is a 95% chance that the true value lies somewhere within this interval. The ELO Delta (25) point acts as a reference to show us the relative increase in performance score based upon a 25 point ELO difference between players. Clearly the impact of ELO massively outweighs the impact of civilisation choice. 

You may also notice that the performance score for Vikings is 0 and has no confidence interval; this is due to how the maths works in that it requires a reference point to calculate all the other values off from. The choice of the reference is completely arbitrary and in this case I chose Vikings because they are the last civisation alphabetically. This is to say that the performance scores you see in this graph represents the difference between that civilisation's performance score and the  performance score of the Vikings.

A natural question is then "ok but what do these numbers actually mean?". The best way to interpret them is to plug them back into the formula mentioned above. For example lets say civilisation A has a score of $0.24$ whilst civilisation B has a value of $-0.13$  . Plugging these values into the above formula (assuming no ELO difference between the two players) gives us:
$$
\frac{1}{1+e^{-(0.24 - (-0.13))}} = \frac{1}{1+e^{-0.37}} = 0.591
$$

That is to say our model predicts that, with no difference in ELO between the two players, there is a 59.1% chance that civilisation A would beat civilisation B in a 1v1 game on Arabia for players with a mean ELO of ~ 1450. For reference the following table provides a mapping from the difference in performance score to the expected win percentages:

```{r, results="asis", echo=FALSE}
logistic <- function(x)  1 / (1 + exp(-x))
dat <- tibble(
    x = seq(0.5, -0.5, by = -0.1),
    y = paste0(round(logistic(x) * 100, 2), "%")
) %>%
    select(
        `Difference in Performance Score` = x,
        `Expected Win Percentage` = y
    )


kable(dat, align = "cc", "html") %>%
    kable_styling(full_width = F)

```


Note that an obvious limitation to this modeling approach is that it assumes linearity in the performance scores, that is to say it assumes that if team A beats team B and team B beats team C then team A should also beat team C. Obviously it is clear this logic does not hold in AOE2 where team superiority is multifaceted. Regardless, the model still gives us a good estimate of the teams average performance. 

An alternative to modeling the civilisations performance is instead to focus on the civilisation classification to see if any particular class of civilisation is showing evidence of being dominant. Using the classes defined in game we get the following performance metrics:



### Bradley-Terry Performance Scores By Civilisation (Solo Games)
<img src="../outputs/g_ia_bt_civ.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Bradley-Terry Performance Scores By Civilisation and Play Rate (Solo Games)
<img src="../outputs/g_ia_bt_civ_PR.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Bradley-Terry Performance Scores By Unit (Solo Games)
<img src="../outputs/g_ia_bt_cu.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>





### Bradley-Terry Performance Scores By Civilisation (Team Games)
<img src="../outputs/g_ta_bt_civ.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Bradley-Terry Performance Scores By Civilisation and Play Rate (Team Games)
<img src="../outputs/g_ta_bt_civ_PR.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Bradley-Terry Performance Scores By Civilisation (Solo vs Team Games)
<img src="../outputs/g_bt_civ.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>





## Naive Win Rates

### Naive Win Rate By Civilisation (Solo Games)
<img src="../outputs/g_ia_desc_WR.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Difference in Civilisation Win Rate from the Mean by ELO  (Solo Games)
<img src="../outputs/g_ia_slice.png" width="80%" style="display: block; margin: auto;" />
<br/> <br/>

### Naive Win Rate By Civilisation (Team Games)
<img src="../outputs/g_ta_desc_WR.png" width="70%" style="display: block; margin: auto;" />
<br/> <br/>

### Difference in Civilisation Win Rate from the Mean by ELO  (Team Games)
<img src="../outputs/g_ta_slice.png" width="80%" style="display: block; margin: auto;" />
<br/> <br/>





## Civilisation vs Civilisation Results

### Hierarchical Clustering Dendrogram (Solo Games)
<img src="../outputs/g_ia_cvc_clust.png" width="70%" style="display: block; margin: auto;" />
<br/><br/>


### Individual Civilisation Plots (Solo Games) {.tabset .tabset-fade .tabset-pills}

```{r, echo = FALSE, results = "asis"}
cl <- readRDS("./outputs/g_ia_cvc_civs_meta.Rds")
id <- "cvcip"
cat(glue::glue('<label for="{id}">Select a Civilisation: </label>'))
cat(glue::glue('<input id="{id}">'))
for ( civ in names(cl)){
    file <- cl[[civ]]
    display <- if_else(civ == "Aztecs", "true", "none")
    cat(glue::glue('<div class="{id}" id="{id}-{civ}" style="display:{display};">'))
    cat(glue::glue('<img src=".{file}" width="70%" style="display: block; margin: auto;" />'))
    cat("</div>")
}
```


### Optimal Civilisation Selection (Solo Games)

```{r, echo = FALSE, results = "asis"}
odat <- readRDS("./outputs/t_ia_cvc_opt.Rds") %>%
    filter(p != 0) %>%
    mutate(p = paste(round(p * 100,2), "%")) %>%
    select(Civilisation = names, `Selection Rate` = p) 

kable(odat, align = "cr", "html") %>%
    kable_styling(full_width = F)

```

## Frequently Asked Questions & Critiques

The following are common critiques and questions I see with regards to assessing civilisation win rate statistics along with my personal opinion / response towards them.

<br/>

**1) You shouldn't include games with players below an ELO of X as the civilisation is nowhere near as important as other factors such as their overall understanding of the game and are likely making a ton of mistakes which don't reflect the civilisations overall ability / balance.**

I have two main objections to this argument, the first being more statistical in nature and the other being my personal feelings towards what it means to "balance" a game. 

So my first argument is that just because civilisation is less important that player skill doesn't mean that these games don't have value. Fundamentally the low ELO just means there is more noise in the data and that it's harder to pick out the signal. However this does NOT mean that the data is useless and we should disregard it. It just means we need more of it in order to identify the effects of the choice of civilisation.

My second argument is that I don't think it is sensible to just balance the game based upon the pros / perfect play of a civilisation; I strongly believe we should strive to ensure the game is balanced across all levels of gameplay. As an extreme example let's imagine we have a civ that completely dominates and is oppressive at ELOs <= 1500 but that the pros are easily able to counter with pixel perfect micro. Would you consider this balanced just because the pros are fine with it even though it breaks the game for the vast vast majority of players ? Alas I feel it is important to assess and strive for balance across all levels of play and not just at the top levels. 

<br/>

**2) You need to account for players who play the vast majority of their games as a single civilisation**

This actually tends to be a non-issue due to the fact that games are balanced by their ELO rating which equates to their average in-game performance. Sure as a player plays more games with a specific civilisation they get good at using that civilisation and thus get better at using it. As a result their ELO rises until they are playing other players that can use their civilisations equally as well. The common argument is then that when the player who uses the same civilisation all the time uses a different civilisation they are super likely to lose and thus bias the results of the other civilisations. In reality though the fact that they only play a single civilisation all the time means that they contribute nearly no data for the other civilisations, and yes whilst this data might be biased, thus has no meaningful impact on the win rates of the other civilisations. 

<br/><br/>



